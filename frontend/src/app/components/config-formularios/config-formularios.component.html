<div class="config-container">
  <div class="header-config">
    <div class="header-icon">‚öôÔ∏è</div>
    <h2>Configuraci√≥n de Formularios por M√≥dulo</h2>
    <p class="subtitle">
      Personaliza qu√© campos aparecen en el formulario de soporte seg√∫n cada m√≥dulo
    </p>
  </div>

  <!-- Mensajes -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
    <button (click)="error = ''" class="btn-close">√ó</button>
  </div>

  <div *ngIf="exito" class="alert alert-success">
    {{ exito }}
    <button (click)="exito = ''" class="btn-close">√ó</button>
  </div>

  <!-- Buscador -->
  <div class="search-container">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input
        type="text"
        [(ngModel)]="terminoBusqueda"
        (ngModelChange)="filtrarModulos()"
        placeholder="Busca un m√≥dulo para configurar su formulario..."
        class="search-input"
      />
      <button
        *ngIf="terminoBusqueda"
        (click)="terminoBusqueda = ''; filtrarModulos()"
        class="btn-clear-search"
      >
        √ó
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando configuraciones...</p>
  </div>

  <!-- Estado vac√≠o -->
  <div *ngIf="!cargando && !terminoBusqueda" class="empty-search-state">
    <div class="empty-icon">üìù</div>
    <h3>Busca un m√≥dulo para empezar</h3>
    <p>Escribe el nombre del m√≥dulo que deseas configurar</p>
  </div>

  <!-- Sin resultados -->
  <div
    *ngIf="!cargando && terminoBusqueda && configuracionesFiltradas.length === 0"
    class="no-results-state"
  >
    <div class="empty-icon">üîç</div>
    <h3>No se encontraron resultados</h3>
    <p>No hay m√≥dulos que coincidan con "{{ terminoBusqueda }}"</p>
  </div>

  <!-- Lista de m√≥dulos -->
  <div *ngIf="!cargando && configuracionesFiltradas.length > 0" class="modulos-grid">
    <div *ngFor="let moduloConfig of configuracionesFiltradas" class="modulo-card">
      <div class="modulo-header">
        <div class="modulo-title-wrapper">
          <h3>{{ moduloConfig.modulo_nombre }}</h3>
          <div class="modulo-badges">
            <span
              *ngFor="let nombreModulo of getRutaModulos(moduloConfig.modulo_id)"
              class="modulo-badge"
            >
              {{ nombreModulo }}
            </span>
          </div>
        </div>
        <!--<span class="modulo-id">ID: {{ moduloConfig.modulo_id }}</span>-->
      </div>

      <!-- Info y Campos Personalizados -->
      <div class="info-campos-fijos">
        <p class="info-text">
          <strong>üìã Formulario Completamente Personalizable</strong>
        </p>
        <p class="info-secondary">
          Todos los campos del formulario de soporte deben agregarse manualmente. Se recomienda
          incluir al menos: Nombre, Correo y Descripci√≥n del Problema.
        </p>
      </div>

      <!-- Campos Personalizados -->
      <div class="campos-personalizados-section">
        <div class="section-header">
          <h4>‚ûï Campos Personalizados</h4>
          <button class="btn btn-add-campo" (click)="abrirModalAgregarCampo(moduloConfig)">
            + Agregar Campo
          </button>
        </div>

        <div
          *ngIf="moduloConfig.camposPersonalizados && moduloConfig.camposPersonalizados.length > 0"
          class="campos-lista"
        >
          <div *ngFor="let campo of moduloConfig.camposPersonalizados" class="campo-personalizado">
            <div class="campo-info">
              <div class="campo-header-custom">
                <strong>{{ campo.etiqueta }}</strong>
                <span class="campo-tipo-badge">{{ getTipoLabel(campo.tipo) }}</span>
                <span *ngIf="campo.requerido" class="campo-requerido-badge">Requerido</span>
                <span
                  *ngIf="!campo.visible"
                  class="campo-oculto-badge"
                  title="Campo oculto en el formulario"
                >
                  üëÅÔ∏è‚Äçüó®Ô∏è Oculto
                </span>
              </div>
              <div class="campo-detalles">
                <small *ngIf="campo.placeholder">Placeholder: {{ campo.placeholder }}</small>
                <small *ngIf="campo.descripcion_ayuda">Ayuda: {{ campo.descripcion_ayuda }}</small>
                <small *ngIf="campo.opciones && campo.opciones.length > 0">
                  Opciones: {{ campo.opciones.join(', ') }}
                </small>
              </div>
            </div>
            <div class="campo-acciones">
              <button
                class="btn-icon btn-visibility-icon"
                (click)="toggleVisibilidadCampo(moduloConfig, campo)"
                [title]="campo.visible ? 'Ocultar campo' : 'Mostrar campo'"
              >
                {{ campo.visible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è' }}
              </button>
              <button
                class="btn-icon btn-edit-icon"
                (click)="abrirModalEditarCampo(moduloConfig, campo)"
                title="Editar"
              >
                ‚úèÔ∏è
              </button>
              <button
                class="btn-icon btn-delete-icon"
                (click)="eliminarCampo(moduloConfig, campo)"
                title="Eliminar"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>

        <div
          *ngIf="
            !moduloConfig.camposPersonalizados || moduloConfig.camposPersonalizados.length === 0
          "
          class="campos-empty"
        >
          <p>No hay campos personalizados. Haz clic en "+ Agregar Campo" para crear uno.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="!cargando && configuraciones.length === 0" class="empty-state">
    <div class="empty-icon">üì¶</div>
    <h3>No hay m√≥dulos configurados</h3>
    <p>Agrega m√≥dulos primero para poder configurar sus formularios</p>
  </div>

  <!-- Modal para Agregar/Editar Campo -->
  <div *ngIf="mostrarModalCampo" class="modal-overlay" (click)="cerrarModalCampo()">
    <div class="modal-content modal-campo" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ campoEditando ? 'Editar Campo' : 'Agregar Campo Personalizado' }}</h3>
        <button class="btn-close" (click)="cerrarModalCampo()">√ó</button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="guardarCampo()">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre del Campo *</label>
              <input
                type="text"
                [(ngModel)]="nuevoCampo.nombre_campo"
                name="nombre_campo"
                placeholder="nombre_sin_espacios"
                required
              />
              <small>Nombre t√©cnico (sin espacios ni caracteres especiales)</small>
            </div>

            <div class="form-group">
              <label>Etiqueta Visible *</label>
              <input
                type="text"
                [(ngModel)]="nuevoCampo.etiqueta"
                name="etiqueta"
                placeholder="Etiqueta que ver√° el usuario"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Tipo de Campo *</label>
              <select [(ngModel)]="nuevoCampo.tipo" name="tipo" required>
                <option *ngFor="let tipo of tiposCampo" [value]="tipo.valor">
                  {{ tipo.label }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Tama√±o de Columna (1-12)</label>
              <input
                type="number"
                [(ngModel)]="nuevoCampo.tamano_columna"
                name="tamano_columna"
                min="1"
                max="12"
              />
              <small>12 = ancho completo, 6 = mitad, etc.</small>
            </div>
          </div>

          <div class="form-group">
            <label>Placeholder</label>
            <input
              type="text"
              [(ngModel)]="nuevoCampo.placeholder"
              name="placeholder"
              placeholder="Texto de ejemplo en el campo"
            />
          </div>

          <div class="form-group">
            <label>Descripci√≥n de Ayuda</label>
            <textarea
              [(ngModel)]="nuevoCampo.descripcion_ayuda"
              name="descripcion_ayuda"
              rows="2"
              placeholder="Texto de ayuda que aparecer√° debajo del campo"
            ></textarea>
          </div>

          <!-- Opciones para select, radio, checkbox -->
          <div *ngIf="requiereOpciones(nuevoCampo.tipo!)" class="form-group opciones-group">
            <label>Opciones *</label>
            <div
              *ngFor="let opcion of nuevoCampo.opciones; let i = index; trackBy: trackByIndex"
              class="opcion-item"
            >
              <input
                type="text"
                [(ngModel)]="nuevoCampo.opciones![i]"
                [name]="'opcion_' + i"
                placeholder="Opci√≥n {{ i + 1 }}"
              />
              <button type="button" class="btn-remove-opcion" (click)="eliminarOpcion(i)">√ó</button>
            </div>
            <button type="button" class="btn btn-add-opcion" (click)="agregarOpcion()">
              + Agregar Opci√≥n
            </button>
          </div>

          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="nuevoCampo.requerido" name="requerido" />
              <span>Campo requerido</span>
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="nuevoCampo.visible" name="visible" />
              <span>Campo visible</span>
            </label>
            <small>Desmarcar para ocultar el campo en el formulario</small>
          </div>

          <div class="modal-actions">
            <button type="submit" class="btn btn-save-modal">
              {{ campoEditando ? 'Actualizar Campo' : 'Agregar Campo' }}
            </button>
            <button type="button" class="btn btn-cancel-modal" (click)="cerrarModalCampo()">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
