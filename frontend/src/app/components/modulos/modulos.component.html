<div class="modulos-container">
  <div class="modules-header">
    <button class="btn-back" (click)="regresarCategories()">
      <span class="back-icon">‚Üê</span>
      <span class="back-label">Inicio</span>
    </button>

    <div class="header-content">
      <div class="header-title-row">
        <div>
          <h1 *ngIf="categoria">üìÇ {{ categoria.nombre }}</h1>
          <h1 *ngIf="!categoria">üìÇ Contenido</h1>
          <p *ngIf="categoria && categoria.descripcion">{{ categoria.descripcion }}</p>
        </div>
        <button *ngIf="authService.isAdmin()" class="btn-add-module" (click)="openForm()">
          + Nuevo M√≥dulo
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando secciones...</p>
  </div>

  <div *ngIf="error && !loading" class="error-alert">
    <span class="error-icon">‚ö†Ô∏è</span>
    <div class="error-content">
      <p class="error-title">Algo sali√≥ mal</p>
      <p class="error-message">{{ error }}</p>
      <button (click)="cargarModulos()" class="btn-retry">Intentar de nuevo</button>
    </div>
  </div>

  <div *ngIf="!loading && !error && modulos.length === 0" class="empty-state">
    <p class="empty-icon">üì≠</p>
    <h3>No hay secciones disponibles</h3>
    <p class="empty-description">
      Esta categor√≠a a√∫n no tiene contenido. Intenta con otra o contacta al administrador.
    </p>
  </div>

  <div *ngIf="!loading && modulos.length > 0" class="modules-wrapper">
    <div class="modules-grid">
      <div *ngFor="let modulo of modulos" class="module-card">
        <div class="card-top">
          <div class="card-header-row">
            <h2 class="module-title">{{ modulo.nombre }}</h2>
            <div *ngIf="authService.isAdmin()" class="card-actions">
              <button class="btn-icon btn-edit" (click)="openForm(modulo)" title="Editar">
                ‚úèÔ∏è
              </button>
              <button class="btn-icon btn-delete" (click)="deleteModulo(modulo)" title="Eliminar">
                üóëÔ∏è
              </button>
            </div>
          </div>
          <p *ngIf="modulo.descripcion" class="module-description">
            {{ modulo.descripcion }}
          </p>
          <p *ngIf="!modulo.descripcion" class="module-description placeholder">
            Informaci√≥n disponible
          </p>
        </div>

        <div class="card-bottom">
          <!-- Si tiene subm√≥dulos, mostrar opci√≥n de explorar -->
          <button
            *ngIf="tieneSubmodulos(modulo.id)"
            class="btn-action btn-explore"
            (click)="irASubmodulos(modulo.id)"
            type="button"
          >
            <span>Explorar</span>
            <span class="action-arrow">‚Üí</span>
          </button>

          <!-- Si NO tiene subm√≥dulos, mostrar opci√≥n de preguntas -->
          <button
            *ngIf="!tieneSubmodulos(modulo.id)"
            class="btn-action btn-questions"
            (click)="irAPreguntas(modulo.id)"
            type="button"
          >
            <span>Ver informaci√≥n</span>
            <span class="action-arrow">‚Üí</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de formulario -->
  <div *ngIf="showForm" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>{{ isEditing ? 'Editar M√≥dulo' : 'Nuevo M√≥dulo' }}</h2>
        <button class="close-btn" (click)="closeForm()">‚úï</button>
      </div>

      <form (ngSubmit)="saveModulo()" class="module-form">
        <div class="form-group">
          <label>Nombre: <span class="required">*</span></label>
          <input
            type="text"
            [(ngModel)]="form.nombre"
            name="nombre"
            placeholder="Nombre del m√≥dulo"
            required
          />
        </div>

        <div class="form-group">
          <label>Descripci√≥n:</label>
          <textarea
            [(ngModel)]="form.descripcion"
            name="descripcion"
            placeholder="Descripci√≥n del m√≥dulo (opcional)"
            rows="3"
          ></textarea>
        </div>

        <div class="hierarchy-section">
          <h3>üìÇ Ubicaci√≥n en la jerarqu√≠a</h3>
          <p class="hierarchy-help">
            Selecciona d√≥nde quieres crear este m√≥dulo. Deja todos vac√≠os para crear una categor√≠a
            principal.
          </p>

          <!-- Nivel 1: Categor√≠a -->
          <div class="form-group">
            <label>
              <span class="level-badge">Nivel 1</span>
              Categor√≠a:
            </label>
            <select
              class="form-control"
              [(ngModel)]="form.categoriaId"
              name="categoriaId"
              (change)="onCategoriaChange()"
            >
              <option [value]="null">-- Ninguna (crear categor√≠a principal) --</option>
              <option *ngFor="let cat of categorias" [value]="cat.id">
                {{ cat.nombre }}
              </option>
            </select>
          </div>

          <!-- Nivel 2: M√≥dulo -->
          <div class="form-group" *ngIf="modulosNivel2.length > 0">
            <label>
              <span class="level-badge level-2">Nivel 2</span>
              M√≥dulo:
            </label>
            <select
              class="form-control"
              [(ngModel)]="form.moduloNivel2Id"
              name="moduloNivel2Id"
              (change)="onModuloNivel2Change()"
            >
              <option [value]="null">-- Ninguno (crear aqu√≠) --</option>
              <option *ngFor="let mod of modulosNivel2" [value]="mod.id">
                {{ mod.nombre }}
              </option>
            </select>
          </div>

          <!-- Nivel 3: Subm√≥dulo -->
          <div class="form-group" *ngIf="modulosNivel3.length > 0">
            <label>
              <span class="level-badge level-3">Nivel 3</span>
              Subm√≥dulo:
            </label>
            <select
              class="form-control"
              [(ngModel)]="form.moduloNivel3Id"
              name="moduloNivel3Id"
              (change)="onModuloNivel3Change()"
            >
              <option [value]="null">-- Ninguno (crear aqu√≠) --</option>
              <option *ngFor="let mod of modulosNivel3" [value]="mod.id">
                {{ mod.nombre }}
              </option>
            </select>
          </div>

          <!-- Nivel 4: Sub-subm√≥dulo -->
          <div class="form-group" *ngIf="modulosNivel4.length > 0">
            <label>
              <span class="level-badge level-4">Nivel 4</span>
              Sub-subm√≥dulo:
            </label>
            <select
              class="form-control"
              [(ngModel)]="form.moduloNivel4Id"
              name="moduloNivel4Id"
              (change)="onModuloNivel4Change()"
            >
              <option [value]="null">-- Ninguno (crear aqu√≠) --</option>
              <option *ngFor="let mod of modulosNivel4" [value]="mod.id">
                {{ mod.nombre }}
              </option>
            </select>
          </div>
        </div>

        <!-- Vista previa de la ubicaci√≥n -->
        <div class="form-group preview-box">
          <strong>üìå Vista previa de ubicaci√≥n:</strong>
          <div class="preview-content">
            <p class="preview-text">
              <span class="badge" [class.subcategory]="form.idpadre">
                {{ form.idpadre ? 'SUBM√ìDULO' : 'CATEGOR√çA PRINCIPAL' }}
              </span>
              <span>{{ getVistaPrevia() }}</span>
            </p>
          </div>
        </div>

        <div *ngIf="error" class="error-message">{{ error }}</div>

        <div class="form-actions">
          <button type="submit" class="save-btn">
            {{ isEditing ? 'Actualizar' : 'Guardar' }}
          </button>
          <button type="button" class="cancel-btn" (click)="closeForm()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>
